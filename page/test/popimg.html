<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>@font-face{font-family:iconfont;src:url(//at.alicdn.com/t/font_rkqci97br3xo5hfr.eot?t=1494575302744);src:url(//at.alicdn.com/t/font_rkqci97br3xo5hfr.eot?t=1494575302744#iefix) format("embedded-opentype"),url(//at.alicdn.com/t/font_rkqci97br3xo5hfr.woff?t=1494575302744) format("woff"),url(//at.alicdn.com/t/font_rkqci97br3xo5hfr.ttf?t=1494575302744) format("truetype"),url(//at.alicdn.com/t/font_rkqci97br3xo5hfr.svg?t=1494575302744#iconfont) format("svg")}.iconfont{font-family:iconfont!important;font-size:16px;font-style:normal;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-edite:before{content:"\e600"}.icon-icon:before{content:"\e60d"}.icon-yes:before{content:"\e608"}.icon-close:before{content:"\e607"}.icon-menu:before{content:"\e646"}.icon-down:before{content:"\e601"}.icon-close_m:before{content:"\e612"}.icon-add:before{content:"\e602"}.icon-del:before{content:"\e603"}.icon-eye:before{content:"\e605"}.icon-tianjia:before{content:"\e66d"}.icon-right-arrow:before{content:"\e613"}.icon-upload:before{content:"\e606"}.icon-bianji:before{content:"\e610"}.icon-shanchu:before{content:"\e87b"}.icon-tianjia1:before{content:"\e627"}.icon-no:before{content:"\e609"}.icon-yes1:before{content:"\e60a"}.icon-chexiao:before{content:"\e60b"}.icon-bianji1:before{content:"\e60f"}.icon-up:before{content:"\e604"}.icon-sb:before{content:"\e60c"}.icon-shanchu1:before{content:"\e611"}.icon-shijian:before{content:"\e60e"}.icon-left-arrow:before{content:"\e87c"}</style>
        <style>.popimg-panel .popimg-overlay{display:none;position:fixed;width:100%;height:100%;z-index:100;background:#000;opacity:0;top:0;right:0;bottom:0;left:0;-webkit-transition:all .35s ease-in-out;transition:all .35s ease-in-out}.popimg-panel .popimg-loader{display:none;position:fixed;top:50%;left:50%;width:50px;height:50px;margin-top:-25px;margin-left:-25px;z-index:101}.popimg-panel .popimg-loader:before{content:'';position:absolute;top:-webkit-calc(50% - 25px);top:calc(50% - 25px);left:-webkit-calc(50% - 25px);left:calc(50% - 25px);width:50px;height:50px;border-radius:50%;border-top:2px solid #55C594;border-left:2px solid #55C594;border-right:2px solid #55C594;border-bottom:2px solid transparent;-webkit-animation:.8s rotate infinite linear normal;animation:.8s rotate infinite linear normal}.popimg-panel .popimg-modal{display:none;position:fixed;z-index:102;-webkit-transition:opacity .8s ease,scale .8s ease;transition:opacity .8s ease,scale .8s ease;opacity:0}.popimg-panel .popimg-modal.animate-out{-webkit-transform:scale(5);-ms-transform:scale(5);transform:scale(5);opacity:0;-webkit-transition:all .28s cubic-bezier(0.4,0,1,1);transition:all .28s cubic-bezier(0.4,0,1,1)}.popimg-panel .popimg-modal.fade-out{opacity:0!important;-webkit-transition:opacity .1s ease;transition:opacity .1s ease}.popimg-panel .popimg-modal.animate-in-delay{opacity:1;-webkit-transition-delay:.5s;transition-delay:.5s}.popimg-panel .popimg-modal.animate-in{opacity:1}.popimg-panel .popimg-modal .modal_content{position:relative;width:100%;height:100%}.popimg-panel .popimg-modal img{display:block;width:100%;height:100%}.popimg-panel .popimg-modal .popimg-close,.popimg-panel .popimg-modal .popimg-detail{width:1em;height:1em;font-size:26px;position:absolute;top:0;right:-1.2em;cursor:pointer;color:#ccc;-webkit-transition:all .3s ease-in-out;transition:all .3s ease-in-out}.popimg-panel .popimg-modal .popimg-detail{top:30px;cursor:pointer}.popimg-panel .popimg-modal .popimg-close:hover,.popimg-panel .popimg-modal .popimg-detail:hover{-webkit-transform:scale(1.3);-ms-transform:scale(1.3);transform:scale(1.3)}.popimg-panel .popimg-modal .modal_content{overflow:hidden}.popimg-panel .popimg-modal .modal_content .popimg-list{background-color:rgba(0,0,0,.6);padding:20px;position:absolute;right:0;top:-100%;height:100%;width:30%;max-width:300px;margin:0;list-style:none;-moz-box-sizing:border-box;box-sizing:border-box;color:#fff}.popimg-panel .popimg-modal .modal_content .popimg-list li{word-break:break-all;word-wrap:break-word;opacity:0;-webkit-transition:all .5s ease;transition:all .5s ease;margin-bottom:10px}.popimg-panel .popimg-modal .modal_content .popimg-list.popimg-in li{-webkit-transition-delay:.4s;transition-delay:.4s;opacity:1}.popimg-panel .popimg-switcher-row{display:none;position:fixed;z-index:101;width:100%;height:50px;left:0;top:50%;margin-top:-25px}.popimg-panel .popimg-switcher-row .popimg-switcher{font-style:normal;width:50px;height:50px;line-height:50px;display:inline-block;background:rgba(176,174,174,.1);cursor:pointer;font-size:30px;text-align:center;color:rgba(255,255,255,.6);position:absolute;-webkit-transition:all .3s ease-in-out;transition:all .3s ease-in-out}.popimg-panel .popimg-switcher-row .popimg-switcher.popimg-prev{left:-100%;border-radius:0 2px 2px 0}.popimg-panel .popimg-switcher-row .popimg-switcher.popimg-next{right:-100%;border-radius:2px 0 0 2px}.popimg-panel .popimg-switcher-row .popimg-switcher:hover{background:rgba(176,174,174,.3)}.popimg-show .popimg-overlay{opacity:.85}@-webkit-keyframes rotate{to{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes rotate{to{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}</style>
    </head>
    <body>
        <script type="text/javascript" src="http://static.ws.kukuplay.com/common/lib/jquery/v1.9.2/jquery-1.9.2.js"></script>
        <script type="text/javascript">

window.TPL = window.TPL || {};
TPL.tplmap = TPL.tplmap || {};
TPL.getTpl = TPL.getTpl || function (_id) {
    return TPL.tplmap[_id];
};

(function (TPL) {
    TPL.tplmap['zadmin-popimg'] = '<div class="popimg-panel"><div class="popimg-overlay" style="display: none;"></div><div class="popimg-loader"></div><div class="popimg-modal"><i class="popimg-close iconfont icon-close_m"></i><i class="popimg-detail iconfont icon-menu"></i><div class="modal_content"><ul class="popimg-list"></ul><img src="" /></div></div><div class="popimg-switcher-row"><i class="popimg-switcher popimg-prev iconfont icon-left-arrow"></i><i class="popimg-switcher popimg-next iconfont icon-right-arrow"></i></div></div>';
})(TPL);
   
;

// 依赖jquery
window.popimg = (function () {
    var dominstance = null,
            imgData = [],
            currentIdx = 0,
            animateTimer = null,
            config = {
                spacing: 60,
                beforeShowDetail: function () {
                },
                errorResolve: function () {
                }
            };

    var popimage = {
        init: function (options) {
            config = $.extend(config, options);
            // 初始化必要的dom结构
//          
            // 绑定相关事件
            popimage.initEvent();
        },
        initDom: function () {
            var dom = $(TPL.getTpl("zadmin-popimg"));
            $('body').append(dom);

            return {
                overlay: dom.find(".popimg-overlay"),
                modal: dom.find(".popimg-modal"),
                switcher: dom.find(".popimg-switcher-row"),
            };
        },
        initEvent: function () {
            // -resize
            $(window).on('resize', function () {
                // 触发图片宽高计算方法
                popimage.computePosition();
            });
            var popClass = "popimg-modal";


            $(document).on('click', "." + popClass + " .popimg-close", function (evt) {
                popimage.hide();
            });

            // 切换事件
            $(document).on('click', ".popimg-panel .popimg-prev", function (evt) {
                popimage.switchImg(-1);
            });
            $(document).on('click', ".popimg-panel .popimg-next", function (evt) {
                popimage.switchImg(1);
            });
            // 展示详情
            $(document).on('click', "." + popClass + " .popimg-detail", function (evt) {
                if ($('.' + popClass + '.modal_content>.popimg-list').hasClass('popimg-in')) {
                    $('.' + popClass + '.modal_content>.popimg-list').removeClass('popimg-in').delay(300).animate({top: '-100%'}, 200);
                    return false;
                }
                var data = config.beforeShowDetail() || imgData[currentIdx],
                        tpl = '';
                for (var i in data) {
                    if (i !== 'error') {
                        tpl += '<li>' + i + ': ' + data[i] + '</li>';
                    }
                }
                $('.' + popClass + '.modal_content>.popimg-list').html(tpl).animate({top: 0}, 400).addClass('popimg-in');
            });

//=========对外提供通用class 绑定事件
            $(document).on('click', ".popimg", function (evt) {
                var imgs = $(this).attr("imgs");
                var array = null;
                if (!Ut.Null(imgs)) {
                    array = imgs.split(",");
                    popimage.showImage(array)
                } else {
                    var value = $(this).html();
                    if (!Ut.Null(value) && Ut.isURL(value)) {
                        array = value;
                    }
                }
                if (!Ut.Null(array)) {
                    popimage.showImage(array);
                }
            })

        },
        resetDom: function () {
            dominstance.modal.removeClass('animate-out animate-in');
            dominstance.overlay.removeAttr('style').hide();
            dominstance.switcher.hide().find('*').removeAttr('style');
            $('body').removeClass('popimg-show');
            $('.modal_content>.popimg-list', dominstance.modal).removeAttr('style')
                    .removeClass('popimg-in');
        },
        loadImg: function (src) {
            var dfd = $.Deferred();
            var img = new Image();
            dominstance.overlay.siblings('.popimg-loader').show();
            img.src = src;
            img.onload = function () {
                imgData[currentIdx].width = img.width;
                imgData[currentIdx].height = img.height;
                imgData[currentIdx].aspect_ratio = img.width / img.height;
                imgData[currentIdx].error = false;
                popimage.computePosition();
                dominstance.overlay.siblings('.popimg-loader').hide();
                dfd.resolve();
            };
            img.onerror = function () {
                dominstance.overlay.siblings('.popimg-loader').hide();
                dfd.reject();
            };
            return dfd;
        },
        hide: function () {
            dominstance.overlay.animate({opacity: 0}, 100, function () {
                $(this).hide();
            });
            $('body').removeClass('popimg-show');
            dominstance.modal.addClass('animate-out').delay(400)
                    .removeClass('animate-in animate-in-delay');

            setTimeout(function () {
                popimage.resetDom();
            }, 800);
        },
        showImage: function (data) {
            // 检查是否已经初始化
            if (dominstance === null) {
                dominstance = popimage.getInstance();
            }
            if (data === undefined) {
                return false;
            }
            // data数据支持字符串、数组（数组元素是字符串、对象）
            var selfType = Object.prototype.toString.call(data).slice(8, -1),
                    itemType = Object.prototype.toString.call(data[0]).slice(8, -1);
            popimage.resetDom();
            imgData = [];
            currentIdx = 0;
            // 策略模式
            popimage.settleData[selfType + itemType](data, function () {
                dominstance.overlay.show(0, function () {
                    $('body').addClass('popimg-show');
                });
                if (imgData.length > 1) {
                    // 显示切换箭头
                    dominstance.switcher.fadeIn();
                    popimage.switchImg(0);
                }
                // popimage.settleImage();
            });
        },
        switchImg: function (space) {
            // 防止快速点击
            if (animateTimer) {
                return false;
            }
            dominstance.modal.removeClass('animate-in-delay animate-in').addClass('fade-out');
            // 保证动画执行完毕
            animateTimer = setTimeout(function () {
                currentIdx = currentIdx + space;
                // 循环切换设置
                // currentIdx = currentIdx >= imgData.length ? 0 : currentIdx;
                // currentIdx = currentIdx < 0 ? imgData.length-1 : currentIdx;
                if (currentIdx <= 0) {
                    dominstance.switcher.find('.popimg-prev').animate({left: '-100%'}, 200);
                    dominstance.switcher.find('.popimg-next').animate({right: 0}, 200);
                } else if (currentIdx >= imgData.length - 1) {
                    dominstance.switcher.find('.popimg-next').animate({right: '-100%'}, 200);
                    dominstance.switcher.find('.popimg-prev').animate({left: 0}, 200);
                } else {
                    dominstance.switcher.find('.popimg-prev').animate({left: 0}, 200);
                    dominstance.switcher.find('.popimg-next').animate({right: 0}, 200);
                }

                $('.modal_content>.popimg-list', dominstance.modal).removeAttr('style')
                        .removeClass('popimg-in');
                popimage.settleImage(space);
                animateTimer = null;
            }, 100);
        },
        settleData: {
            "StringString": function (data, cbk) {
                // 传入单个字符串
                imgData.push({src: data});
                cbk();
            },
            "ObjectUndefined": function (data, cbk) {
                // 传入是一个对象，就认为传入的是图片要展示的信息
                imgData.push(data);
                cbk();
            },
            "ArrayString": function (data, cbk) {
                // 传入的是一个数组，每个数组元素是路径
                for (var i = 0, len = data.length; i < len; i++) {
                    imgData.push({src: data[i]});
                }
                console.log(imgData);
                cbk();
            },
            "ArrayObject": function (data, cbk) {
                // 传入的是一个数组，每个数组元素是路径
                for (var i = 0, len = data.length; i < len; i++) {
                    imgData.push(data[i]);
                }
                cbk();
            }

        },
        settleImage: function (space) {
            popimage.loadImg(imgData[currentIdx].src).then(function () {
                if(space === 0){
                    // 首次显示带延迟动画
                    dominstance.modal.show(0).removeClass('fade-out').addClass('animate-in-delay');
                }else{
                    dominstance.modal.show(0).removeClass('fade-out').addClass('animate-in');
                }
                $('.modal_content>img', dominstance.modal).remove();
                $('.modal_content', dominstance.modal).append('<img src="' + imgData[currentIdx].src + '"/>');
            }, function () {
                var res = config.errorResolve();
                if (!res) {
                    imgData[currentIdx].width = 360;
                    imgData[currentIdx].height = 240;
                    imgData[currentIdx].aspect_ratio = 9 / 6;
                    imgData[currentIdx].error = true;
                    popimage.computePosition();
                }
            });
        },
        computePosition: function () {
            var w = $(window).width(),
                    h = $(window).height(),
                    setW = Math.min(w - config.spacing * 2, imgData[currentIdx].width),
                    setH = Math.min(h - config.spacing * 2, imgData[currentIdx].height);
            // 防止图片变形
            if (setW / setH < imgData[currentIdx].aspect_ratio) {
                // 宽度被拉伸
                setH = setW / imgData[currentIdx].aspect_ratio;
            }
            if (setW / setH > imgData[currentIdx].aspect_ratio) {
                setW = setH * imgData[currentIdx].aspect_ratio;
            }
            dominstance.modal.css({left: Math.abs(setW - w) / 2,
                top: Math.abs(setH - h) / 2,
                width: setW,
                height: setH
            });
        },
        getInstance: function () {
            return dominstance ? dominstance : dominstance = popimage.initDom();
        }
    };
    popimage.init();

    return {
        showImage: popimage.showImage
    };
})();</script>
        <div class="preview-photo" data-href="http://fengyun-bar.b0.upaiyun.com/1470742916289691.jpg">click to view img</div>

        <script type="text/javascript">
            $(function () {
                $(".preview-photo").click(function () {
                    popimg.showImage(["http://fengyun-bar.b0.upaiyun.com/1470742916289691.jpg", "http://fengyun-bar.b0.upaiyun.com/1470742916289691.jpg", "http://fengyun-bar.b0.upaiyun.com/1466154941487481.jpg"]);
                })

            });
        </script>
    </body>
</html>
